# 09. ログ出力方針設計書

## 1. はじめに
本ドキュメントは、Chrome拡張機能「Super Mouse Gesture」におけるログ出力の方針について記述する。
適切なログ出力により、開発時のデバッグ効率化、リリース後の問題発生時の原因調査、およびユーザーサポートの迅速化を目的とする。

## 2. ログレベル定義
本システムでは、以下の4つのログレベルを定義し、状況に応じて使い分ける。

| レベル | 意味 | 運用方針 |
| :--- | :--- | :--- |
| **ERROR** | **エラー** | システムの正常な動作が阻害された場合、またはユーザーの要求が処理できなかった場合に出力する。ユーザーへの通知が必要なレベルの障害も含む。 |
| **WARN** | **警告** | 正常な動作は継続可能だが、予期しない状態や注意が必要な状態が発生した場合に出力する。デフォルト値へのフォールバックが発生した場合などが該当する。 |
| **INFO** | **情報** | アプリケーションの正常なライフサイクルや、主要な機能実行の記録として出力する。動作の流れを追跡するための情報。 |
| **DEBUG** | **デバッグ** | 開発およびトラブルシューティング詳細な情報。変数の内容、計算結果、細かいイベントフローなど、内部動作の解析に必要な情報を出力する。本番ビルドでは原則として無効化（またはフィルタリング）されることを想定する。 |

## 3. ログ出力形式
ログは以下の統一フォーマットでコンソール（Chrome DevTools Console）に出力する。

### 3.1. 基本フォーマット
```
[TIMESTAMP] [LEVEL] [CONTEXT] MESSAGE [DATA]
```

### 3.2. 構成要素
| 要素 | 説明 | 例 |
| :--- | :--- | :--- |
| **TIMESTAMP** | ログ出力時刻 (ISO 8601形式 または ローカル時間) | `2023-10-27T10:00:00.123Z` |
| **LEVEL** | ログレベル | `INFO`, `ERROR` |
| **CONTEXT** | 実行コンテキストやコンポーネント名 (Background, ContentScript, Popup, Settings等) | `Background`, `GestureManager` |
| **MESSAGE** | ログの内容を示すテキスト | `Gesture initialized.` |
| **DATA** | (任意) 関連するオブジェクトやデータ構造 | `{ id: "MG-01", direction: "U" }` |

### 3.3. 実装イメージ
```javascript
// 例: logger.info('GestureManager', 'Gesture detected', { path: 'DR' });
[10:00:00.123] [INFO] [GestureManager] Gesture detected { path: 'DR' }
```

## 4. 出力タイミング詳細

### 4.1. ERROR (エラー)
*   **例外発生時**: `try-catch` ブロックで補足された予期せぬ例外。
*   **APIエラー**: `chrome.runtime.lastError` がセットされた場合や、非同期通信（Message Passing）の失敗。
*   **必須リソース欠落**: 必要なDOM要素が見つからない、設定ファイルが読み込めない等のクリティカルな欠損。
*   **権限エラー**: 必要なパーミッションが不足しており機能が実行できない場合。

### 4.2. WARN (警告)
*   **設定不整合**: 設定値が不正だが、デフォルト値で補完して動作継続する場合。
*   **非推奨API使用**: 将来的に廃止される可能性のある機能やAPIを使用している箇所の検知。
*   **パフォーマンス低下**: 処理時間が閾値を超えた場合（例: 重いDOM操作）。
*   **イベント無視**: ジェスチャとして認識されたが、定義済みアクションが存在しないため無視する場合。

### 4.3. INFO (情報)
*   **初期化完了**: 拡張機能（Background, Content Script）のロード完了時。
*   **設定変更**: ユーザー設定が保存・更新されたタイミング。
*   **アクション実行**: ジェスチャやドラッグ操作により、具体的なアクション（タブを開く、閉じる等）が実行されたタイミング。
*   **状態遷移**: 機能のON/OFF切り替えなど、主要な状態変化。

### 4.4. DEBUG (デバッグ)
*   **イベント発火**: `mousedown`, `mousemove`, `mouseup` などの生イベント検知（開発時のみ有効化推奨）。
*   **計算プロセス**: ジェスチャ認識ロジックにおけるベクトル計算、角度判定の途中経過。
*   **通信詳細**: メッセージパッシングの送受信内容詳細。
*   **詳細データ**: 設定オブジェクトの全容ダンプなど。

## 5. ログ管理・制御
*   **環境による制御**: 開発ビルド（Development）では全レベルを出力し、本番ビルド（Production）では `INFO` 以上のみを出力する等の制御機構を設けることが望ましい。
*   **フィルタリング**: 出力時にコンテキストやレベルによるフィルタリングが可能なラッパー関数（Loggerユーティリティ）を通して出力する。

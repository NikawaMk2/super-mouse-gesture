# 04. 機能仕様書

## 1. スーパードラッグ機能 (Super Drag)

### 1.1. 概要
テキストまたはリンク要素をドラッグ＆ドロップすることでアクションを実行する。

### 1.2. 処理フロー
1.  **ドラッグ開始検知**:
    *   ユーザーがWebページ上の要素をドラッグ開始 (`dragstart`)。
    *   ドラッグされたデータを確認（テキスト選択範囲、または `<a>` タグのリンクURL）。
2.  **ドラッグ中**:
    *   通常のドラッグ操作として振る舞う（OS/ブラウザ標準のドラッグアイコン表示）。
3.  **ドロップ検知**:
    *   ドロップイベント (`drop`) を検知。
    *   ドロップ位置が拡張機能の有効範囲内であれば処理を開始。
    *   **デフォルトのドロップ処理を無効化** (preventDefault) するか、設定により制御。
4.  **アクション実行**:
    *   **リンクの場合**:
        *   対象: `href` 属性を持つ `<a>` タグ、または画像リンク。
        *   アクション: 新しいタブでリンク先を開く (`background: false` = 前面で開く)。
    *   **テキストの場合**:
        *   対象: 選択されたテキスト文字列。
        *   アクション: デフォルト検索エンジン（またはGoogle）で新しいタブを開いて検索する。

### 1.3. 制約事項
*   テキストボックス内や編集可能な要素内でのドラッグは、編集操作を阻害しないよう慎重に判定する（または機能を無効化する）。
*   ドラッグ距離が極端に短い場合は誤操作防止のためアクションを実行しない（閾値: 10px程度）。

---

## 2. マウスジェスチャ機能 (Mouse Gesture)

### 2.1. 概要
右クリックを押しながらマウスを移動させることで、定義されたアクションを実行する。

### 2.2. ジェスチャ認識ロジック
1.  **開始**:
    *   `mousedown` (button: 2 = Right Click) を検知。
    *   コンテキストメニューの表示を抑制 (`contextmenu` イベントで `preventDefault`)。
    *   描画用Canvasを準備。
2.  **追跡 (Tracking)**:
    *   `mousemove` で座標を記録。
    *   前回座標からの移動ベクトルを算出。
    *   一定距離（例: 10px）以上移動した場合、方向を判定。
    *   **方向判定**: 4方向 (Up, Down, Left, Right) を基本とする。
        *   角度により判定 (例: -45°〜45° = Right)。
    *   連続して同じ方向が検出された場合は1つの方向として扱う（RRR -> R）。
    *   方向が変化した場合、ジェスチャパスに追加 (例: R -> D -> RD)。
3.  **フィードバック**:
    *   トレイルを描画。
    *   現在のジェスチャパスに対応するアクション定義を検索。
    *   マッチするアクションがあれば画面にアクション名を表示。
4.  **終了/実行**:
    *   `mouseup` (button: 2) を検知。
    *   記録されたジェスチャパスと一致するアクションを実行。
    *   アクション実行後、トレイルと表示を消去。
    *   コンテキストメニューが表示されないように制御。
5.  **キャンセル**:
    *   以下の操作が行われた場合、ジェスチャをキャンセルし、アクションを実行しない。
        *   左クリック (`mousedown` button: 0) が押された場合。
        *   キーボード入力（ESCキーなど）があった場合。
        *   ジェスチャパスが未定義の場合（設定によるが、基本は何もせず終了）。
        *   移動距離が極端に短い場合（通常の右クリックとみなしてコンテキストメニューを表示させる、という設定も考慮するが、本バージョンではジェスチャモードに入った場合はメニュー抑制を基本とする）。

### 2.3. 定義済みジェスチャ一覧
要件定義書に基づき以下のジェスチャを実装する。

| ID | ジェスチャ | 方向 | 機能 |
| :--- | :--- | :--- | :--- |
| MG-01 | **U** | ↑ | 上へスクロール |
| MG-01 | **D** | ↓ | 下へスクロール |
| MG-02 | **L** | ← | 戻る |
| MG-02 | **R** | → | 進む |
| MG-03 | **UL** | ↑← | 前のタブへ |
| MG-03 | **UR** | ↑→ | 次のタブへ |
| MG-04 | **DL** | ↓← | タブを閉じて左へ |
| MG-04 | **DR** | ↓→ | タブを閉じて右へ |
| MG-05 | **LU** | ←↑ | ページ拡大 |
| MG-05 | **LD** | ←↓ | ページ縮小 |
| MG-06 | **RU** | →↑ | 新規タブ |
| MG-07 | **RD** | →↓ | フルスクリーン |
| MG-08 | **DU** | ↓↑ | ページトップへ |
| MG-08 | **UD** | ↑↓ | ページボトムへ |
| MG-09 | **LR** | ←→ | 再読み込み |
| MG-09 | **RL** | →← | 再読み込み（要件では左右のみだが、対称性のため考慮） |
| MG-10 | **RL** | →← | タブ復元（要件では右左） |

※ 上記定義で重複（MG-09, MG-10）があるため、要件定義書の「左右」「右左」を正確にマッピングする。
- MG-09 (再読み込み): 左右 (LR)
- MG-10 (タブ復元): 右左 (RL)
とする。

## 3. アクション詳細仕様

### 3.1. Content Scriptで実行するアクション
以下の操作はDOM操作が必要なため、Content Script内で完結、あるいはCS主導で実行する。

*   **スクロール操作**: `window.scrollBy()`, `window.scrollTo()`
*   **ページトップ/ボトム**: `window.scrollTo(0, 0)`, `window.scrollTo(0, document.body.scrollHeight)`

### 3.2. Service Workerで実行するアクション
以下の操作は特権APIが必要なため、Service Workerへメッセージを送信して実行する。

*   **タブ操作** (`chrome.tabs`): 新規作成、閉じる、移動、復元、選択切替。
*   **ズーム操作** (`chrome.tabs.setZoom`): Content Scriptからは実行不可。
*   **履歴操作** (`chrome.tabs.goBack`, `goForward`): `history.back()` はCSでも可能だが、信頼性のためAPI利用も検討（通常はCSの `window.history` で十分）。本設計ではCSの `window.history` を第一候補とする。
*   **再読み込み**: `chrome.tabs.reload` または CSでの `location.reload()`。CSで十分。
*   **フルスクリーン**: CSでの `document.documentElement.requestFullscreen()` はユーザー操作コンテキストが必要。ジェスチャ終了(`mouseup`)はユーザー操作とみなされるためCSで実行可能。

| アクション | 実行場所 | 備考 |
| :--- | :--- | :--- |
| スクロール | Content Script | |
| 履歴(戻る/進む) | Content Script | `history.back()`, `history.forward()` |
| タブ切り替え | Service Worker | `chrome.tabs.query`, `chrome.tabs.update` |
| タブ閉じる | Service Worker | `chrome.tabs.remove` |
| ズーム | Service Worker | `chrome.tabs.setZoom` |
| 新規タブ | Service Worker | `chrome.tabs.create` |
| フルスクリーン | Content Script | `requestFullscreen()`, `exitFullscreen()` |
| ページトップ/ボトム | Content Script | |
| 再読み込み | Content Script | `location.reload()` |
| タブ復元 | Service Worker | `chrome.sessions.restore` (要 `sessions` 権限) |

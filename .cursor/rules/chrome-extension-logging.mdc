---
description: 
globs: *.ts
alwaysApply: false
---
# ログ出力規則

## 1. ログレベル定義
以下の4段階のログレベルを使用する：
```typescript
enum LogLevel {
  ERROR = 'ERROR',   // エラー（システムの動作に重大な影響がある）
  WARN = 'WARN',     // 警告（システムは動作するが、望ましくない状態）
  INFO = 'INFO',     // 情報（システムの重要な動作の記録）
  DEBUG = 'DEBUG'    // デバッグ（開発時の詳細な情報）
}
```

## 2. ログ出力形式
```typescript
interface LogFormat {
  timestamp: string;    // ISO 8601形式 (YYYY-MM-DDTHH:mm:ss.sssZ)
  level: LogLevel;      // ログレベル
  context: string;      // ログの発生箇所（コンポーネント名/機能名）
  message: string;      // ログメッセージ
  details?: unknown;    // 追加情報（オプション）
}
```

## 3. 環境別ログ出力設定
- 本番環境: ERROR, WARN, INFO のみ出力
- 開発環境: すべてのレベルを出力

## 4. ログ出力ルール
### 4.1 ERROR
- 例外発生時
- APIリクエスト失敗時
- 重要な機能の実行失敗時
```typescript
Logger.error('APIデータの取得に失敗しました', {
  url: 'https://api.example.com',
  statusCode: 500,
  errorMessage: error.message
});
```

### 4.2 WARN
- 非推奨機能の使用時
- パフォーマンス低下の検知時
- リトライ処理発生時
```typescript
Logger.warn('パフォーマンスの低下を検知しました', {
  processingTime: 5000,
  threshold: 3000
});
```

### 4.3 INFO
- 重要な処理の開始/完了
- ユーザーアクション
- 設定変更
```typescript
Logger.info('ユーザー設定を更新しました', {
  settingName: 'theme',
  oldValue: 'light',
  newValue: 'dark'
});
```

### 4.4 DEBUG
- 関数の入出力値
- 処理の中間状態
- 開発時のデバッグ情報
```typescript
Logger.debug('データを処理中', {
  inputData: data,
  step: 'validation'
});
```

## 5. 実装例
```typescript
// src/common/logger/logger.ts
import Environment from '../utils/environment';

interface LogDetails {
    [key: string]: unknown;
}

export default class Logger {
    static debug(message: string, details?: LogDetails) {
        if(!Environment.isDevelopment()) {
            return;
        }
        this.outputLog('DEBUG', message, details);
    }

    static info(message: string, details?: LogDetails) {
        this.outputLog('INFO', message, details);
    }

    static warn(message: string, details?: LogDetails) {
        this.outputLog('WARN', message, details);
    }

    static error(message: string, details?: LogDetails) {
        this.outputErrorLog(message, details);
    }

    private static outputLog(mode: string, message: string, details?: LogDetails): void {
        const timestamp = new Date().toISOString();
        const logMessage = {
            timestamp,
            level: mode,
            message,
            details
        };
        console.log(`[${mode}][${timestamp}]: ${message}`, details || '');
    }

    private static outputErrorLog(message: string, details?: LogDetails): void {
        const timestamp = new Date().toISOString();
        const logMessage = {
            timestamp,
            level: 'ERROR',
            message,
            details
        };
        console.error(`[ERROR][${timestamp}]: ${message}`, details || '');
    }
}
```

## 6. 使用例
```typescript
// APIリクエストの例
try {
    const response = await fetch('https://api.example.com/data');
    if (!response.ok) {
        throw new Error('API request failed');
    }
    Logger.info('APIリクエスト成功', {
        endpoint: '/data',
        statusCode: response.status
    });
} catch (error) {
    Logger.error('APIリクエスト失敗', {
        endpoint: '/data',
        error: error.message
    });
}

// 設定更新の例
function updateSettings(newSettings: any) {
    Logger.debug('設定更新開始', { newSettings });
    try {
        // 設定更新処理
        Logger.info('設定更新完了', {
            updated: true,
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        Logger.error('設定更新失敗', { error: error.message });
    }
}

// パフォーマンス監視の例
function measurePerformance(processingTime: number) {
    const threshold = 3000; // 3秒
    if (processingTime > threshold) {
        Logger.warn('処理時間が閾値を超過', {
            processingTime,
            threshold,
            timestamp: new Date().toISOString()
        });
    }
}
```

## 7. 注意事項
- 個人情報や機密情報はログに出力しない
- 本番環境では詳細なスタックトレースを出力しない
- ログ出力量が多すぎないよう適切なレベルで出力する
- エラーハンドリングとログ出力は必ず組み合わせる
- 出力するログメッセージは全て日本語とする

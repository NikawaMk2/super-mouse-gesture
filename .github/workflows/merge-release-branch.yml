name: Merge Release Branch
run-name: Release ${{ inputs.version }}
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true
        type: string
      auto-merge:
        description: "Automatically merge the release PR"
        required: false
        type: boolean
        default: false
permissions:
  contents: read
jobs:
  validate-variables:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Validate version format
        run: /bin/bash .github/scripts/validate-version.sh "${{ inputs.version }}"
  build:
    runs-on: ubuntu-latest
    needs: [validate-variables]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: develop
      - name: Install dependencies
        run: npm install
      - name: Build
        run: npm run build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build
          path: dist
          retention-days: 1
  execute-test-code:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: develop
      - name: Install dependencies
        run: npm install
      - name: Test
        run: npm test
  execute-e2e-tests:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: develop
      - name: Install dependencies
        run: npm install
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: build
          path: dist
      - name: Verify build artifacts
        run: |
          echo "Checking dist directory..."
          ls -la dist/ || echo "dist directory does not exist"
          if [ ! -f "dist/manifest.json" ]; then
            echo "Error: manifest.json not found in dist directory"
            exit 1
          fi
          echo "Build artifacts verified successfully"
      - name: Test
        run: |
          if ! command -v xvfb-run >/dev/null; then
            sudo apt-get update
            sudo apt-get install -y xvfb
          fi
          xvfb-run --auto-servernum --server-args="-screen 0 1280x720x24" npm run test:e2e
  create-release-branch:
    runs-on: ubuntu-latest
    needs: [execute-test-code, execute-e2e-tests]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: develop
      - name: Create release branch
        run: /bin/bash .github/scripts/create-release-branch.sh "${{ inputs.version }}" develop
  update-version:
    runs-on: ubuntu-latest
    needs: [create-release-branch]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: release/${{ inputs.version }}
      - name: Update version
        run: /bin/bash .github/scripts/update-version.sh "${{ inputs.version }}"
      - name: Commit changes
        run: /bin/bash .github/scripts/commit-version-update.sh "${{ inputs.version }}" release/${{ inputs.version }}
  create-release-pr:
    runs-on: ubuntu-latest
    needs: [update-version]
    permissions:
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: release/${{ inputs.version }}
      - name: Configure Git
        run: /bin/bash .github/scripts/configure-git.sh
      - name: Create release PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr create --title "${{ inputs.version }}にアップデート" --body "${{ inputs.version }}にアップデート" --base main --head release/${{ inputs.version }}
  merge-release-pr:
    runs-on: ubuntu-latest
    needs: [create-release-pr]
    if: ${{ inputs.auto-merge == true }}
    permissions:
      contents: write
    steps:
      - name: Merge release PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head release/${{ inputs.version }} --json number -q '.[0].number')
          if [ -z "$PR_NUMBER" ]; then
            echo "Error: Release PR not found"
            exit 1
          fi
          gh pr merge $PR_NUMBER --auto --delete-branch=false
